{% extends "base.html" %}

{% block header %}Inventory Management{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-boxes"></i> Inventory Management</h5>
        <div class="d-flex gap-2 align-items-center">
            <a href="{{ url_for('add_inventory') }}" class="btn btn-success btn-sm">
                <i class="fas fa-plus"></i> Add Item
            </a>
            <button class="btn btn-info btn-sm" onclick="updateInventory()" title="Update inventory from invoices">
                <i class="fas fa-sync-alt"></i> Update Inventory
            </button>
            <div class="input-group" style="width: 300px;">
                <input type="text" id="searchInput" class="form-control" placeholder="Search inventory...">
                <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div id="loadingMessage" class="alert alert-info">Loading inventory data...</div>
        <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>

        <!-- Inventory Summary Cards -->
        <div class="row mb-4" id="summaryCards" style="display: none;">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="totalItems">0</h4>
                                <p class="mb-0">Total Items</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-cubes fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="totalQuantity">0</h4>
                                <p class="mb-0">Total Quantity</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-warehouse fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="totalValue">$0.00</h4>
                                <p class="mb-0">Total Value</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-dollar-sign fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="avgPrice">$0.00</h4>
                                <p class="mb-0">Average Price</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-chart-bar fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table id="inventoryTable" class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Item Name</th>
                        <th>Category</th>
                        <th>Quantity</th>
                        <th>Unit Price</th>
                        <th>Calculated Price</th>
                        <th>Total Value</th>
                        <th>Barcode</th>
                        <th>Last Updated</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Inventory Item Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
            </div>
        </div>
    </div>
</div>

<!-- Update Progress Modal -->
<div class="modal fade" id="updateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Updating Inventory</h5>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Updating inventory from invoice data...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    console.log('Inventory page loaded');
    console.log('jQuery version:', $.fn.jquery);
    console.log('DataTables available:', typeof $.fn.DataTable !== 'undefined');

    // Check if DataTables is available
    if (typeof $.fn.DataTable === 'undefined') {
        $('#errorMessage').text('DataTables library not loaded. Please refresh the page.').show();
        $('#loadingMessage').hide();
        return;
    }

    // Initialize DataTable
    try {
        let table = $('#inventoryTable').DataTable({
            "processing": true,
            "serverSide": false,
            "ajax": {
                "url": "/api/inventory",
                "type": "GET",
                "dataSrc": function(json) {
                    console.log('Inventory DataTable received data:', json);
                    $('#loadingMessage').hide();
                    if (json.error) {
                        $('#errorMessage').text('Error loading data: ' + json.error).show();
                        return [];
                    }

                    // Calculate and display summary
                    calculateSummary(json.data || []);
                    $('#summaryCards').show();

                    return json.data || [];
                },
                "error": function(xhr, error, code) {
                    console.error('Inventory DataTable AJAX error:', error, code, xhr.responseText);
                    $('#loadingMessage').hide();
                    $('#errorMessage').text('Error loading data: ' + error).show();
                }
            },
            "columns": [
                {"data": "id"},
                {"data": "item_name"},
                {"data": "category"},
                {
                    "data": "total_quantity",
                    "render": function(data) {
                        return data || 0;
                    }
                },
                {
                    "data": "unit_price",
                    "render": function(data) {
                        return data ? '$' + parseFloat(data).toFixed(2) : '$0.00';
                    }
                },
                {
                    "data": "calculated_price",
                    "render": function(data) {
                        return data ? '$' + parseFloat(data).toFixed(2) : '$0.00';
                    }
                },
                {
                    "data": null,
                    "render": function(data, type, row) {
                        let quantity = row.total_quantity || 0;
                        let price = row.calculated_price || 0;
                        let totalValue = quantity * price;
                        return '$' + totalValue.toFixed(2);
                    }
                },
                {"data": "barcode"},
                {"data": "last_updated"},
                {
                    "data": null,
                    "orderable": false,
                    "render": function(data, type, row) {
                        return `
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-primary" onclick="showDetails(${row.id})" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <a href="/inventory/edit/${row.id}" class="btn btn-sm btn-warning" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button class="btn btn-sm btn-danger" onclick="deleteRecord(${row.id})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                    }
                }
            ],
            "order": [[ 3, "desc" ]], // Sort by quantity descending
            "pageLength": 25,
            "language": {
                "processing": "Loading inventory...",
                "emptyTable": "No inventory items found"
            }
        });

        // Store table reference globally for search function
        window.inventoryTable = table;

    } catch (error) {
        console.error('Error initializing Inventory DataTable:', error);
        $('#loadingMessage').hide();
        $('#errorMessage').text('Error initializing table: ' + error.message).show();
    }

    // Search functionality
    $('#searchBtn').click(function() {
        let searchTerm = $('#searchInput').val();
        console.log('Searching inventory for:', searchTerm);

        if (searchTerm && window.inventoryTable) {
            $.get('/api/search/inventory?q=' + encodeURIComponent(searchTerm))
                .done(function(data) {
                    console.log('Inventory search results:', data);
                    window.inventoryTable.clear();
                    window.inventoryTable.rows.add(data.data || []);
                    window.inventoryTable.draw();

                    // Update summary with filtered data
                    calculateSummary(data.data || []);
                })
                .fail(function(xhr, status, error) {
                    console.error('Inventory search error:', error);
                    alert('Inventory search failed: ' + error);
                });
        } else if (window.inventoryTable) {
            window.inventoryTable.ajax.reload();
        }
    });

    $('#searchInput').keypress(function(e) {
        if(e.which == 13) {
            $('#searchBtn').click();
        }
    });

    $('#searchInput').on('input', function() {
        if($(this).val() === '' && window.inventoryTable) {
            window.inventoryTable.ajax.reload();
        }
    });
});

// Calculate and display summary statistics
function calculateSummary(data) {
    let totalItems = data.length;
    let totalQuantity = 0;
    let totalValue = 0;

    data.forEach(function(item) {
        totalQuantity += item.total_quantity || 0;
        totalValue += (item.total_quantity || 0) * (item.calculated_price || 0);
    });

    let avgPrice = totalItems > 0 ? totalValue / totalQuantity : 0;

    $('#totalItems').text(totalItems);
    $('#totalQuantity').text(totalQuantity);
    $('#totalValue').text('$' + totalValue.toFixed(2));
    $('#avgPrice').text('$' + avgPrice.toFixed(2));
}

// Update inventory function
function updateInventory() {
    console.log('Updating inventory...');

    // Show update modal
    $('#updateModal').modal('show');

    // In a real implementation, you would call the update_inventory.py script
    // For now, we'll simulate it and reload the table
    setTimeout(function() {
        $('#updateModal').modal('hide');

        // Show success message
        let alertHtml = '<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                       'Inventory updated successfully! Run <code>python3 update_inventory.py</code> to update from invoices.' +
                       '<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>';

        $('.card-body').prepend(alertHtml);

        // Reload table
        if (window.inventoryTable) {
            window.inventoryTable.ajax.reload();
        }

        // Auto-remove alert after 5 seconds
        setTimeout(function() {
            $('.alert-success').alert('close');
        }, 5000);

    }, 2000);
}

// Global function for showing details
function showDetails(recordId) {
    console.log('Showing inventory details for record ID:', recordId);

    $.get('/api/inventory')
        .done(function(data) {
            let record = data.data.find(r => r.id === recordId);
            if (record) {
                let html = '<div class="row">';
                for(let key in record) {
                    if(record[key] !== null && record[key] !== '' && record[key] !== undefined) {
                        let displayKey = key.replace(/_/g, ' ').toUpperCase();
                        let displayValue = record[key];

                        // Format monetary values
                        if(key.includes('price') || key.includes('value')) {
                            if(!isNaN(displayValue)) {
                                displayValue = '$' + parseFloat(displayValue).toFixed(2);
                            }
                        }

                        html += '<div class="col-md-6 mb-2"><strong>' + displayKey + ':</strong> ' + displayValue + '</div>';
                    }
                }

                // Add calculated total value
                let totalValue = (record.total_quantity || 0) * (record.calculated_price || 0);
                html += '<div class="col-md-6 mb-2"><strong>TOTAL VALUE:</strong> $' + totalValue.toFixed(2) + '</div>';

                html += '</div>';
                $('#modalBody').html(html);
                $('#detailModal').modal('show');
            } else {
                alert('Inventory record not found');
            }
        })
        .fail(function(xhr, status, error) {
            console.error('Error fetching inventory details:', error);
            alert('Error loading inventory details: ' + error);
        });
}

// Global function for deleting records
function deleteRecord(recordId) {
    if (confirm('Are you sure you want to delete this inventory item? This action cannot be undone.')) {
        // Create a form and submit it for DELETE request
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/inventory/delete/${recordId}`;
        form.style.display = 'none';
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}