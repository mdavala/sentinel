{% extends "base.html" %}

{% block header %}Edit Daily Book Closing Record{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-edit"></i> Edit Daily Book Closing Record #{{ record.id }}</h5>
                <a href="{{ url_for('daily_book_closing') }}" class="btn btn-secondary btn-sm">
                    <i class="fas fa-arrow-left"></i> Back to List
                </a>
            </div>
            <div class="card-body">
                <form method="POST">
                    <!-- Basic Information -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="closing_date" class="form-label">Closing Date <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="closing_date" name="closing_date" value="{{ record.closing_date }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="total_sales" class="form-label">Total Sales</label>
                                <input type="number" step="0.01" class="form-control" id="total_sales" name="total_sales" value="{{ record.total_sales or '' }}">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Transaction Information -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="number_of_transactions" class="form-label">Number of Transactions</label>
                                <input type="number" class="form-control" id="number_of_transactions" name="number_of_transactions" value="{{ record.number_of_transactions or '' }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="average_sales_per_transaction" class="form-label">Average Sales per Transaction</label>
                                <input type="number" step="0.01" class="form-control" id="average_sales_per_transaction" name="average_sales_per_transaction" value="{{ record.average_sales_per_transaction or '' }}">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payment Methods -->
                    <h6 class="mb-3 mt-4 text-primary border-bottom pb-2">Payment Methods</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="nets_qr_amount" class="form-label">NETS QR Amount</label>
                                <input type="number" step="0.01" class="form-control" id="nets_qr_amount" name="nets_qr_amount" value="{{ record.nets_qr_amount or '' }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="cash_amount" class="form-label">Cash Amount</label>
                                <input type="number" step="0.01" class="form-control" id="cash_amount" name="cash_amount" value="{{ record.cash_amount or '' }}">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="credit_amount" class="form-label">Credit Amount</label>
                                <input type="number" step="0.01" class="form-control" id="credit_amount" name="credit_amount" value="{{ record.credit_amount or '' }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="nets_amount" class="form-label">NETS Amount</label>
                                <input type="number" step="0.01" class="form-control" id="nets_amount" name="nets_amount" value="{{ record.nets_amount or '' }}">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Settlement Information -->
                    <h6 class="mb-3 mt-4 text-success border-bottom pb-2">Settlement Information</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="total_settlement" class="form-label">Total Settlement</label>
                                <input type="number" step="0.01" class="form-control" id="total_settlement" name="total_settlement" value="{{ record.total_settlement or '' }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="expected_cash_balance" class="form-label">Expected Cash Balance</label>
                                <input type="number" step="0.01" class="form-control" id="expected_cash_balance" name="expected_cash_balance" value="{{ record.expected_cash_balance or '' }}">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Credits and Voids -->
                    <h6 class="mb-3 mt-4 text-warning border-bottom pb-2">Credits & Voids</h6>
                    <div class="row">
                        <!-- <div class="col-md-6">
                            <div class="mb-3">
                                <label for="total_credit_given" class="form-label">Total Credit Given</label>
                                <input type="number" step="0.01" class="form-control" id="total_credit_given" name="total_credit_given" value="{{ record.total_credit_given or '' }}">
                            </div>
                        </div> -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="voided_transactions" class="form-label">Voided Transactions</label>
                                <input type="number" class="form-control" id="voided_transactions" name="voided_transactions" value="{{ record.voided_transactions or '' }}">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="voided_amount" class="form-label">Voided Amount</label>
                                <input type="number" step="0.01" class="form-control" id="voided_amount" name="voided_amount" value="{{ record.voided_amount or '' }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="cash_outs" class="form-label">Cash Outs</label>
                                <textarea class="form-control" id="cash_outs" name="cash_outs" rows="3">{{ record.cash_outs or '' }}</textarea>
                                <small class="form-text text-muted">Enter as array format: [amount1, amount2] or plain text</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Show current processed time -->
                    {% if record.processed_at %}
                    <div class="row">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <strong>Originally Processed:</strong> {{ record.processed_at }}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="d-flex justify-content-end gap-2 mt-4">
                        <a href="{{ url_for('daily_book_closing') }}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Update Record
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Auto-calculate script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-calculate average sales per transaction
    const totalSales = document.getElementById('total_sales');
    const numTransactions = document.getElementById('number_of_transactions');
    const avgSales = document.getElementById('average_sales_per_transaction');
    
    function calculateAverage() {
        const sales = parseFloat(totalSales.value) || 0;
        const transactions = parseInt(numTransactions.value) || 0;
        
        if (transactions > 0 && sales > 0) {
            avgSales.value = (sales / transactions).toFixed(2);
        }
    }
    
    totalSales.addEventListener('input', calculateAverage);
    numTransactions.addEventListener('input', calculateAverage);
    
    // Auto-calculate total settlement
    const netsQr = document.getElementById('nets_qr_amount');
    const cash = document.getElementById('cash_amount');
    const ahaCredit = document.getElementById('credit_amount');
    const nets = document.getElementById('nets_amount');
    const totalSettlement = document.getElementById('total_settlement');
    
    function calculateTotalSettlement() {
        const netsQrVal = parseFloat(netsQr.value) || 0;
        const cashVal = parseFloat(cash.value) || 0;
        const ahaCreditVal = parseFloat(ahaCredit.value) || 0;
        const netsVal = parseFloat(nets.value) || 0;
        
        const total = netsQrVal + cashVal + ahaCreditVal + netsVal;
        if (total > 0) {
            totalSettlement.value = total.toFixed(2);
        }
    }
    
    [netsQr, cash, ahaCredit, nets].forEach(field => {
        field.addEventListener('input', calculateTotalSettlement);
    });
});
</script>
{% endblock %}