{% extends "base.html" %}

{% block header %}Order Recommendations{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-shopping-cart"></i> Order Recommendations</h5>
                    <div class="d-flex gap-2 align-items-center">
                        <input type="date" id="targetDate" class="form-control" style="width: 200px;">
                        <button class="btn btn-light btn-sm" onclick="refreshRecommendations()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn btn-success btn-sm" onclick="show14DayView()">
                            <i class="fas fa-calendar-alt"></i> 14-Day View
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h6 class="text-muted">Total Suppliers</h6>
                                <h4 class="text-primary" id="totalSuppliers">-</h4>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h6 class="text-muted">Critical Items</h6>
                                <h4 class="text-danger" id="criticalItems">-</h4>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h6 class="text-muted">High Priority Items</h6>
                                <h4 class="text-warning" id="highPriorityItems">-</h4>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h6 class="text-muted">Estimated Total</h6>
                                <h4 class="text-success" id="estimatedTotal">$-</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading and Error Messages -->
    <div id="loadingMessage" class="alert alert-info" style="display: none;">
        <i class="fas fa-spinner fa-spin"></i> Loading recommendations...
    </div>
    <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>

    <!-- Daily Recommendations -->
    <div id="dailyRecommendations" class="row">
        <!-- Recommendations will be loaded here -->
    </div>

    <!-- 14-Day Schedule Modal -->
    <div class="modal fade" id="scheduleModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">14-Day Order Schedule</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="scheduleContent">
                        <!-- 14-day schedule will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Details Modal -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Product Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="productModalBody">
                    <!-- Product details will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    console.log('Order Recommendations page loaded');

    // Set today's date as default
    const today = new Date().toISOString().split('T')[0];
    $('#targetDate').val(today);

    // Load initial recommendations
    loadRecommendations();
});

function loadRecommendations() {
    const targetDate = $('#targetDate').val();

    $('#loadingMessage').show();
    $('#errorMessage').hide();
    $('#dailyRecommendations').empty();

    // Reset summary stats
    $('#totalSuppliers').text('-');
    $('#criticalItems').text('-');
    $('#highPriorityItems').text('-');
    $('#estimatedTotal').text('$-');

    $.get('/api/order-recommendations', { date: targetDate })
        .done(function(response) {
            $('#loadingMessage').hide();

            if (response.success) {
                displayRecommendations(response.data);
                updateSummaryStats(response.data);
            } else {
                $('#errorMessage').text('Error: ' + response.error).show();
            }
        })
        .fail(function(xhr, status, error) {
            $('#loadingMessage').hide();
            $('#errorMessage').text('Failed to load recommendations: ' + error).show();
        });
}

function displayRecommendations(recommendations) {
    const container = $('#dailyRecommendations');

    if (!recommendations || recommendations.length === 0) {
        container.html(`
            <div class="col-12">
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle"></i> No orders recommended for this date.
                    <br><small>All suppliers appear to have sufficient stock or recent orders.</small>
                </div>
            </div>
        `);
        return;
    }

    recommendations.forEach(function(supplier) {
        const urgencyClass = getUrgencyClass(supplier.products);
        const shouldOrderBadge = supplier.should_order_today ?
            '<span class="badge bg-success">Order Today</span>' :
            '<span class="badge bg-secondary">Future Order</span>';

        const card = $(`
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center ${urgencyClass}">
                        <h6 class="mb-0 text-white">
                            <i class="fas fa-truck"></i> ${supplier.supplier_name}
                        </h6>
                        ${shouldOrderBadge}
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-6">
                                <small class="text-muted">Products</small>
                                <div class="fw-bold">${supplier.total_products}</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Est. Amount</small>
                                <div class="fw-bold text-success">$${supplier.estimated_order_amount.toFixed(2)}</div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6">
                                <small class="text-muted">Delivery Freq.</small>
                                <div class="fw-bold">${supplier.delivery_frequency}</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Last Order</small>
                                <div class="fw-bold">${supplier.last_order_days_ago} days ago</div>
                            </div>
                        </div>
                        <div class="product-list" style="max-height: 200px; overflow-y: auto;">
                            ${supplier.products.map(product => `
                                <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                                    <div>
                                        <div class="fw-bold" style="font-size: 0.9em;">${product.product_name}</div>
                                        <small class="text-muted">Stock: ${product.current_stock} | Need: ${product.recommended_quantity}</small>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge ${getUrgencyBadgeClass(product.urgency)}">${product.urgency}</span>
                                        <button class="btn btn-sm btn-outline-primary mt-1" onclick="showProductDetails('${product.product_name}', '${supplier.supplier_name}')">
                                            <i class="fas fa-info-circle"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="card-footer">
                        <button class="btn btn-primary btn-sm w-100" onclick="markAsOrdered('${supplier.supplier_name}')">
                            <i class="fas fa-check"></i> Mark as Ordered
                        </button>
                    </div>
                </div>
            </div>
        `);

        container.append(card);
    });
}

function updateSummaryStats(recommendations) {
    let totalSuppliers = recommendations.length;
    let criticalItems = 0;
    let highPriorityItems = 0;
    let estimatedTotal = 0;

    recommendations.forEach(function(supplier) {
        estimatedTotal += supplier.estimated_order_amount;
        supplier.products.forEach(function(product) {
            if (product.urgency === 'critical') criticalItems++;
            if (product.urgency === 'high') highPriorityItems++;
        });
    });

    $('#totalSuppliers').text(totalSuppliers);
    $('#criticalItems').text(criticalItems);
    $('#highPriorityItems').text(highPriorityItems);
    $('#estimatedTotal').text('$' + estimatedTotal.toFixed(2));
}

function getUrgencyClass(products) {
    const hasCritical = products.some(p => p.urgency === 'critical');
    const hasHigh = products.some(p => p.urgency === 'high');

    if (hasCritical) return 'bg-danger';
    if (hasHigh) return 'bg-warning';
    return 'bg-primary';
}

function getUrgencyBadgeClass(urgency) {
    switch(urgency) {
        case 'critical': return 'bg-danger';
        case 'high': return 'bg-warning';
        case 'medium': return 'bg-info';
        case 'low': return 'bg-secondary';
        default: return 'bg-secondary';
    }
}

function refreshRecommendations() {
    loadRecommendations();
}

function show14DayView() {
    const startDate = $('#targetDate').val();

    $('#scheduleModal').modal('show');
    $('#scheduleContent').html('<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading 14-day schedule...</div>');

    $.get('/api/order-recommendations/schedule', { start_date: startDate })
        .done(function(response) {
            if (response.success) {
                display14DaySchedule(response.data);
            } else {
                $('#scheduleContent').html('<div class="alert alert-danger">Error: ' + response.error + '</div>');
            }
        })
        .fail(function(xhr, status, error) {
            $('#scheduleContent').html('<div class="alert alert-danger">Failed to load schedule: ' + error + '</div>');
        });
}

function display14DaySchedule(schedule) {
    const container = $('#scheduleContent');

    let html = '<div class="row">';

    Object.keys(schedule).forEach(function(dateKey) {
        const day = schedule[dateKey];
        const dayClass = day.recommendations.length > 0 ? 'border-primary' : 'border-light';

        html += `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card ${dayClass}">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">${day.day_name}</h6>
                        <small class="text-muted">${day.date}</small>
                    </div>
                    <div class="card-body">
                        <div class="row text-center mb-2">
                            <div class="col-4">
                                <small class="text-muted">Suppliers</small>
                                <div class="fw-bold">${day.total_suppliers}</div>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">Critical</small>
                                <div class="fw-bold text-danger">${day.critical_items}</div>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">High</small>
                                <div class="fw-bold text-warning">${day.high_priority_items}</div>
                            </div>
                        </div>
                        ${day.recommendations.slice(0, 3).map(supplier => `
                            <div class="small mb-1">
                                <i class="fas fa-truck"></i> ${supplier.supplier_name}
                                <span class="badge bg-secondary float-end">${supplier.total_products}</span>
                            </div>
                        `).join('')}
                        ${day.recommendations.length > 3 ? `<small class="text-muted">+${day.recommendations.length - 3} more...</small>` : ''}
                    </div>
                    ${day.recommendations.length > 0 ? `
                        <div class="card-footer">
                            <button class="btn btn-sm btn-outline-primary w-100" onclick="loadDayRecommendations('${day.date}')">
                                View Details
                            </button>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    });

    html += '</div>';
    container.html(html);
}

function loadDayRecommendations(date) {
    $('#targetDate').val(date);
    $('#scheduleModal').modal('hide');
    loadRecommendations();
}

function showProductDetails(productName, supplierName) {
    $('#productModal').modal('show');
    $('#productModalBody').html(`
        <div class="text-center">
            <i class="fas fa-spinner fa-spin"></i> Loading product details...
        </div>
    `);

    // For now, show basic product info
    // This could be enhanced to show more detailed analytics
    $('#productModalBody').html(`
        <div class="row">
            <div class="col-md-6">
                <h6>Product Information</h6>
                <p><strong>Product Name:</strong> ${productName}</p>
                <p><strong>Supplier:</strong> ${supplierName}</p>
            </div>
            <div class="col-md-6">
                <h6>Recommendation Details</h6>
                <p><em>Detailed analytics coming soon...</em></p>
                <p>This will include sales trends, stock levels, and demand patterns.</p>
            </div>
        </div>
    `);
}

function markAsOrdered(supplierName) {
    if (confirm(`Mark all recommended products from ${supplierName} as ordered?`)) {
        // This could be enhanced to actually update the system
        alert(`Order marked for ${supplierName}. This feature will be enhanced to update the tracking system.`);

        // Refresh recommendations after marking as ordered
        loadRecommendations();
    }
}
</script>
{% endblock %}