{% extends "base.html" %}

{% block header %}Payment Records{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-credit-card"></i> Payment Records</h5>
        <div class="d-flex gap-2 align-items-center">
            <a href="{{ url_for('add_payment') }}" class="btn btn-success btn-sm">
                <i class="fas fa-plus"></i> Add Payment
            </a>
            <button class="btn btn-info btn-sm" onclick="updatePayments()" title="Update payment statuses from UOB emails">
                <i class="fas fa-sync-alt"></i> Update Payments
            </button>
            <button class="btn btn-danger btn-sm" id="bulkDeleteBtn" style="display: none;" onclick="showBulkDeleteModal(bulkDeletePayments)">
                <i class="fas fa-trash"></i> Delete Selected <span class="badge bg-light text-dark">0</span>
            </button>
            <div class="input-group" style="width: 300px;">
                <input type="text" id="searchInput" class="form-control" placeholder="Search payments...">
                <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div id="loadingMessage" class="alert alert-info">Loading data...</div>
        <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>
        
        <div class="table-responsive">
            <table id="paymentsTable" class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>
                            <input type="checkbox" id="selectAll" onchange="selectAllRows(this, 'paymentsTable')">
                        </th>
                        <th>ID</th>
                        <th>Invoice Number</th>
                        <th>Supplier</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Due Date</th>
                        <th>Payment Type</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Payment Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    console.log('Payments page loaded');
    console.log('jQuery version:', $.fn.jquery);
    console.log('DataTables available:', typeof $.fn.DataTable !== 'undefined');
    
    // Check if DataTables is available
    if (typeof $.fn.DataTable === 'undefined') {
        $('#errorMessage').text('DataTables library not loaded. Please refresh the page.').show();
        $('#loadingMessage').hide();
        return;
    }
    
    // Initialize DataTable
    try {
        let table = $('#paymentsTable').DataTable({
            "processing": true,
            "serverSide": false,
            "ajax": {
                "url": "/api/payments",
                "type": "GET",
                "dataSrc": function(json) {
                    console.log('Payments DataTable received data:', json);
                    $('#loadingMessage').hide();
                    if (json.error) {
                        $('#errorMessage').text('Error loading data: ' + json.error).show();
                        return [];
                    }
                    return json.data || [];
                },
                "error": function(xhr, error, code) {
                    console.error('Payments DataTable AJAX error:', error, code, xhr.responseText);
                    $('#loadingMessage').hide();
                    $('#errorMessage').text('Error loading data: ' + error).show();
                }
            },
            "columns": [
                {
                    "data": null,
                    "orderable": false,
                    "render": function(data, type, row) {
                        return `<input type="checkbox" data-row-id="${row.id}" onchange="toggleRowSelection(this, ${row.id})">`;
                    }
                },
                {"data": "id"},
                {"data": "invoice_number"},
                {"data": "supplier_name"},
                {
                    "data": "total_amount",
                    "render": function(data) {
                        return data ? '$' + parseFloat(data).toFixed(2) : 'N/A';
                    }
                },
                {
                    "data": "payment_status",
                    "render": function(data) {
                        let status = data || 'Unknown';
                        let badgeClass = status.toLowerCase() === 'paid' ? 'bg-success' :
                                       status.toLowerCase() === 'pending' ? 'bg-warning' :
                                       status.toLowerCase() === 'overdue' ? 'bg-danger' : 'bg-secondary';
                        return '<span class="badge ' + badgeClass + '">' + status + '</span>';
                    }
                },
                {"data": "payment_due_date"},
                {"data": "payment_type"},
                {
                    "data": null,
                    "orderable": false,
                    "render": function(data, type, row) {
                        return `
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-primary" onclick="showDetails(${row.id})" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <a href="/payments/edit/${row.id}" class="btn btn-sm btn-warning" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button class="btn btn-sm btn-danger" onclick="deleteRecord(${row.id})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                    }
                }
            ],
            "order": [[ 1, "desc" ]],
            "pageLength": 25,
            "language": {
                "processing": "Loading payments...",
                "emptyTable": "No payment records found"
            }
        });
        
        // Store table reference globally for search function
        window.paymentsTable = table;
        
    } catch (error) {
        console.error('Error initializing Payments DataTable:', error);
        $('#loadingMessage').hide();
        $('#errorMessage').text('Error initializing table: ' + error.message).show();
    }

    // Search functionality
    $('#searchBtn').click(function() {
        let searchTerm = $('#searchInput').val();
        console.log('Searching payments for:', searchTerm);
        
        if (searchTerm && window.paymentsTable) {
            $.get('/api/search/payments?q=' + encodeURIComponent(searchTerm))
                .done(function(data) {
                    console.log('Payment search results:', data);
                    window.paymentsTable.clear();
                    window.paymentsTable.rows.add(data.data || []);
                    window.paymentsTable.draw();
                })
                .fail(function(xhr, status, error) {
                    console.error('Payment search error:', error);
                    alert('Payment search failed: ' + error);
                });
        } else if (window.paymentsTable) {
            window.paymentsTable.ajax.reload();
        }
    });

    $('#searchInput').keypress(function(e) {
        if(e.which == 13) {
            $('#searchBtn').click();
        }
    });

    $('#searchInput').on('input', function() {
        if($(this).val() === '' && window.paymentsTable) {
            window.paymentsTable.ajax.reload();
        }
    });
});

// Global function for showing details
function showDetails(recordId) {
    console.log('Showing payment details for record ID:', recordId);
    
    $.get('/api/payments')
        .done(function(data) {
            let record = data.data.find(r => r.id === recordId);
            if (record) {
                let html = '<div class="row">';
                for(let key in record) {
                    if(record[key] !== null && record[key] !== '' && record[key] !== undefined) {
                        let displayKey = key.replace(/_/g, ' ').toUpperCase();
                        let displayValue = record[key];
                        
                        // Format monetary values
                        if(key.includes('amount')) {
                            if(!isNaN(displayValue)) {
                                displayValue = '$' + parseFloat(displayValue).toFixed(2);
                            }
                        }
                        
                        html += '<div class="col-md-6 mb-2"><strong>' + displayKey + ':</strong> ' + displayValue + '</div>';
                    }
                }
                html += '</div>';
                $('#modalBody').html(html);
                $('#detailModal').modal('show');
            } else {
                alert('Payment record not found');
            }
        })
        .fail(function(xhr, status, error) {
            console.error('Error fetching payment details:', error);
            alert('Error loading payment details: ' + error);
        });
}

// Global function for deleting records
function deleteRecord(recordId) {
    showCustomConfirm(
        'Are you sure you want to delete 1 payment record? This action cannot be undone.',
        function() {
            // Create a form and submit it for DELETE request
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/payments/delete/${recordId}`;
            form.style.display = 'none';
            document.body.appendChild(form);
            form.submit();
        }
    );
}

// Global function for updating payments from UOB emails
function updatePayments() {
    showCustomConfirm(
        'This will process UOB payment emails from the last 24 hours and update payment statuses. Continue?',
        function() {
            // Show loading indicator
            const button = event.target.closest('button');
            const originalHtml = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
            button.disabled = true;

            // Create and submit form
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/payments/update';
            form.style.display = 'none';
            document.body.appendChild(form);
            form.submit();
        }
    );
}

// Bulk delete function for payments
function bulkDeletePayments(selectedIds) {
    if (selectedIds.length === 0) return;

    // Show loading message
    const loadingAlert = $('<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Deleting selected records...</div>');
    $('.card-body').prepend(loadingAlert);

    // Use AJAX to call the bulk delete endpoint
    $.ajax({
        url: '/api/bulk-delete/payments',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ids: selectedIds}),
        success: function(response) {
            loadingAlert.remove();
            if (response.success) {
                // Show success message
                const successAlert = $(`<div class="alert alert-success alert-dismissible fade show">
                    <i class="fas fa-check"></i> Successfully deleted ${response.deleted_count} payment records!
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>`);
                $('.card-body').prepend(successAlert);

                // Reload table data
                if (window.paymentsTable) {
                    window.paymentsTable.ajax.reload();
                }

                // Auto-remove alert after 5 seconds
                setTimeout(() => successAlert.alert('close'), 5000);
            } else {
                // Show error message
                const errorAlert = $(`<div class="alert alert-danger alert-dismissible fade show">
                    <i class="fas fa-exclamation-triangle"></i> Error: ${response.error}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>`);
                $('.card-body').prepend(errorAlert);
            }
        },
        error: function(xhr, status, error) {
            loadingAlert.remove();
            console.error('Bulk delete error:', error);
            const errorAlert = $(`<div class="alert alert-danger alert-dismissible fade show">
                <i class="fas fa-exclamation-triangle"></i> Error deleting records: ${error}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`);
            $('.card-body').prepend(errorAlert);
        }
    });
}
</script>
{% endblock %}