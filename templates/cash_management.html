{% extends "base.html" %}

{% block header %}Cash Management{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-money-bill-wave"></i> Cash Management</h5>
        <div class="d-flex gap-2 align-items-center flex-wrap">
            <!-- Date Range Toggle -->
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="dateRangeToggle">
                <label class="form-check-label" for="dateRangeToggle">
                    Date Range
                </label>
            </div>

            <!-- Single Date Filter -->
            <div class="input-group" id="singleDateGroup" style="width: 250px;">
                <input type="date" id="dateFilter" class="form-control" value="{{ selected_date or today }}">
                <button class="btn btn-outline-secondary" type="button" id="filterBtn">
                    <i class="fas fa-search"></i> Filter
                </button>
            </div>

            <!-- Date Range Filter -->
            <div class="d-flex gap-2" id="dateRangeGroup" style="display: none;">
                <div class="input-group" style="width: 150px;">
                    <input type="date" id="startDate" class="form-control" placeholder="Start Date">
                </div>
                <div class="input-group" style="width: 150px;">
                    <input type="date" id="endDate" class="form-control" placeholder="End Date">
                </div>
                <button class="btn btn-outline-secondary" type="button" id="rangeFilterBtn">
                    <i class="fas fa-search"></i> Filter Range
                </button>
            </div>

        </div>
    </div>
    <div class="card-body">
        <div id="loadingMessage" class="alert alert-info">Loading cash denomination data...</div>
        <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>

        <!-- Cash Summary Cards -->
        <div class="row mb-4" id="summaryCards" style="display: none;">
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="totalAmount">$0.00</h4>
                                <p class="mb-0">Total Cash</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-dollar-sign fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="billsTotal">$0.00</h4>
                                <p class="mb-0">Bills Total</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-money-bill fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="coinsTotal">$0.00</h4>
                                <p class="mb-0">Coins Total</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-coins fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="entryInfo">--:--</h4>
                                <p class="mb-0" id="entryInfoLabel">Entry Time</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-clock fa-2x" id="entryInfoIcon"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Date Range Summary Banner -->
        <div class="alert alert-info" id="rangeSummary" style="display: none;">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-1"><i class="fas fa-calendar-alt"></i> Date Range Summary</h6>
                    <span id="rangeDates">--</span>
                </div>
                <div class="text-end">
                    <strong id="rangeEntries">-- entries</strong>
                </div>
            </div>
        </div>

        <!-- No Data Message -->
        <div id="noDataMessage" class="alert alert-warning" style="display: none;">
            <div class="text-center">
                <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                <h5>No cash denomination data found for this date</h5>
                <p class="mb-3">Click "Add Entry" button below to enter cash denomination counts.</p>
                <button class="btn btn-primary btn-lg" onclick="showEntryForm()">
                    <i class="fas fa-plus"></i> Add Entry
                </button>
            </div>
        </div>

        <!-- Cash Denomination Entry Form -->
        <div id="entryForm" class="card mb-4" style="display: none;">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0" id="formTitle"><i class="fas fa-edit"></i> Enter Cash Denominations</h6>
                <button class="btn btn-sm btn-light" onclick="hideEntryForm()">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
            <div class="card-body">
                <form id="cashDenominationForm">
                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label fw-bold">Date</label>
                            <input type="date" class="form-control" id="entryDateInput" required>
                        </div>
                    </div>

                    <!-- Bills Section -->
                    <div class="card mb-3">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0"><i class="fas fa-money-bill"></i> Bills</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-2">
                                <div class="col-4 col-md-2">
                                    <label class="form-label">$100</label>
                                    <input type="number" class="form-control denomination-input" id="dollar_100" min="0" value="0" oninput="calculateTotals()">
                                </div>
                                <div class="col-4 col-md-2">
                                    <label class="form-label">$50</label>
                                    <input type="number" class="form-control denomination-input" id="dollar_50" min="0" value="0" oninput="calculateTotals()">
                                </div>
                                <div class="col-4 col-md-2">
                                    <label class="form-label">$10</label>
                                    <input type="number" class="form-control denomination-input" id="dollar_10" min="0" value="0" oninput="calculateTotals()">
                                </div>
                                <div class="col-4 col-md-2">
                                    <label class="form-label">$5</label>
                                    <input type="number" class="form-control denomination-input" id="dollar_5" min="0" value="0" oninput="calculateTotals()">
                                </div>
                                <div class="col-4 col-md-2">
                                    <label class="form-label">$2</label>
                                    <input type="number" class="form-control denomination-input" id="dollar_2" min="0" value="0" oninput="calculateTotals()">
                                </div>
                                <div class="col-4 col-md-2">
                                    <label class="form-label fw-bold text-success">Bills: $<span id="billsSubtotal">0.00</span></label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Coins Section -->
                    <div class="card mb-3">
                        <div class="card-header bg-warning text-white">
                            <h6 class="mb-0"><i class="fas fa-coins"></i> Coins</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-2">
                                <div class="col-4 col-md-2">
                                    <label class="form-label">$1</label>
                                    <input type="number" class="form-control denomination-input" id="dollar_1" min="0" value="0" oninput="calculateTotals()">
                                </div>
                                <div class="col-4 col-md-2">
                                    <label class="form-label">50¢</label>
                                    <input type="number" class="form-control denomination-input" id="cent_50" min="0" value="0" oninput="calculateTotals()">
                                </div>
                                <div class="col-4 col-md-2">
                                    <label class="form-label">20¢</label>
                                    <input type="number" class="form-control denomination-input" id="cent_20" min="0" value="0" oninput="calculateTotals()">
                                </div>
                                <div class="col-4 col-md-2">
                                    <label class="form-label">10¢</label>
                                    <input type="number" class="form-control denomination-input" id="cent_10" min="0" value="0" oninput="calculateTotals()">
                                </div>
                                <div class="col-4 col-md-2">
                                    <label class="form-label">5¢</label>
                                    <input type="number" class="form-control denomination-input" id="cent_5" min="0" value="0" oninput="calculateTotals()">
                                </div>
                                <div class="col-4 col-md-2">
                                    <label class="form-label fw-bold text-warning">Coins: $<span id="coinsSubtotal">0.00</span></label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Grand Total -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <h5 class="mb-0">Grand Total: $<span id="grandTotal">0.00</span></h5>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="row">
                        <div class="col-12">
                            <button type="submit" class="btn btn-success w-100">
                                <i class="fas fa-save"></i> Save Cash Denomination
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Date Range Data Table -->
        <div id="rangeDataTable" style="display: none;">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="fas fa-table"></i> Cash Denomination Entries</h6>
                    <button id="bulkDeleteBtn" class="btn btn-danger btn-sm" style="display: none;" onclick="showBulkDeleteModal(bulkDeleteCashEntries)">
                        <i class="fas fa-trash"></i> Delete Selected <span class="badge bg-light text-dark">0</span>
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="cashEntriesTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>
                                        <input type="checkbox" id="selectAllCash" onchange="selectAllRows(this, 'cashEntriesTable')">
                                    </th>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Total Amount</th>
                                    <th>Bills Total</th>
                                    <th>Coins Total</th>
                                    <th>Entered By</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cash Denomination Details -->
        <div id="denominationDetails" style="display: none;">
            <div class="row">
                <!-- Bills Section -->
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0"><i class="fas fa-money-bill"></i> Bills</h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Denomination</th>
                                            <th>Quantity</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="billsTable">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Coins Section -->
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header bg-warning text-white">
                            <h6 class="mb-0"><i class="fas fa-coins"></i> Coins</h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Denomination</th>
                                            <th>Quantity</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="coinsTable">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Metadata and Actions -->
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-info-circle"></i> Entry Information</h6>
                            <div>
                                <button class="btn btn-warning btn-sm me-2" onclick="editCashEntry()">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteSingleCashEntry()">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <strong>Entry Date:</strong><br>
                                    <span id="entryDate">--</span>
                                </div>
                                <div class="col-md-3">
                                    <strong>Entry Time:</strong><br>
                                    <span id="entryTimeDetail">--:--</span>
                                </div>
                                <div class="col-md-3">
                                    <strong>Entered By:</strong><br>
                                    <span id="enteredBy">--</span>
                                </div>
                                <div class="col-md-3">
                                    <strong>Last Updated:</strong><br>
                                    <span id="lastUpdated">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variable to store current entry data
let currentCashEntry = null;

$(document).ready(function() {
    console.log('Cash Management page loaded');

    // Load data for the selected date
    loadCashData();

    // Date range toggle handler
    $('#dateRangeToggle').change(function() {
        if (this.checked) {
            $('#singleDateGroup').hide();
            $('#dateRangeGroup').show();
        } else {
            $('#singleDateGroup').show();
            $('#dateRangeGroup').hide();
            // Clear any existing range data when switching back to single date
            $('#rangeDataTable').hide();
            $('#rangeSummary').hide();
        }
    });

    // Single date filter button click handler
    $('#filterBtn').click(function() {
        loadCashData();
    });

    // Date range filter button click handler
    $('#rangeFilterBtn').click(function() {
        loadCashDataRange();
    });

    // Date input change handler
    $('#dateFilter').change(function() {
        loadCashData();
    });

    // Handle form submission
    $('#cashDenominationForm').submit(function(e) {
        e.preventDefault();

        const formData = {
            entry_date: $('#entryDateInput').val(),
            entry_time: new Date().toTimeString().split(' ')[0],
            dollar_100_qty: parseInt($('#dollar_100').val() || 0),
            dollar_50_qty: parseInt($('#dollar_50').val() || 0),
            dollar_10_qty: parseInt($('#dollar_10').val() || 0),
            dollar_5_qty: parseInt($('#dollar_5').val() || 0),
            dollar_2_qty: parseInt($('#dollar_2').val() || 0),
            dollar_1_qty: parseInt($('#dollar_1').val() || 0),
            cent_50_qty: parseInt($('#cent_50').val() || 0),
            cent_20_qty: parseInt($('#cent_20').val() || 0),
            cent_10_qty: parseInt($('#cent_10').val() || 0),
            cent_5_qty: parseInt($('#cent_5').val() || 0)
        };

        // Disable submit button
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.html();
        submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Saving...');

        $.ajax({
            url: '/api/cash-denomination/save',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                submitBtn.prop('disabled', false).html(originalText);

                if (response.success) {
                    showFlashMessage('Cash denomination saved successfully! Total: $' + response.grand_total, 'success');
                    hideEntryForm();

                    // Update the date filter and reload data
                    $('#dateFilter').val(formData.entry_date);
                    loadCashData();
                } else {
                    showFlashMessage('Error saving cash denomination: ' + response.error, 'error');
                }
            },
            error: function(xhr, status, error) {
                submitBtn.prop('disabled', false).html(originalText);
                showFlashMessage('Error saving cash denomination: ' + error, 'error');
            }
        });
    });
});

function loadCashData() {
    const selectedDate = $('#dateFilter').val();
    console.log('Loading cash data for date:', selectedDate);

    $('#loadingMessage').show();
    $('#errorMessage').hide();
    $('#summaryCards').hide();
    $('#denominationDetails').hide();
    $('#noDataMessage').hide();
    $('#rangeDataTable').hide();
    $('#rangeSummary').hide();

    $.ajax({
        url: '/api/cash-denomination',
        method: 'GET',
        data: { date: selectedDate },
        success: function(response) {
            $('#loadingMessage').hide();

            if (response.success && response.data) {
                displayCashData(response.data);
            } else {
                $('#noDataMessage').show();
            }
        },
        error: function(xhr, status, error) {
            console.error('Error loading cash data:', error);
            $('#loadingMessage').hide();
            $('#errorMessage').text('Error loading cash denomination data: ' + error).show();
        }
    });
}

function loadCashDataRange() {
    const startDate = $('#startDate').val();
    const endDate = $('#endDate').val();

    if (!startDate || !endDate) {
        alert('Please select both start and end dates for the range.');
        return;
    }

    if (startDate > endDate) {
        alert('Start date cannot be later than end date.');
        return;
    }

    console.log('Loading cash data for range:', startDate, 'to', endDate);

    $('#loadingMessage').show();
    $('#errorMessage').hide();
    $('#summaryCards').hide();
    $('#denominationDetails').hide();
    $('#noDataMessage').hide();
    $('#rangeDataTable').hide();
    $('#rangeSummary').hide();

    $.ajax({
        url: '/api/cash-denomination',
        method: 'GET',
        data: {
            start_date: startDate,
            end_date: endDate
        },
        success: function(response) {
            $('#loadingMessage').hide();

            if (response.success && response.data && response.data.length > 0) {
                displayCashDataRange(response.data, response.summary);
            } else {
                $('#noDataMessage').show();
            }
        },
        error: function(xhr, status, error) {
            console.error('Error loading cash data range:', error);
            $('#loadingMessage').hide();
            $('#errorMessage').text('Error loading cash denomination data range: ' + error).show();
        }
    });
}

function displayCashData(data) {
    console.log('Displaying cash data:', data);

    // Store current entry data globally for edit/delete operations
    currentCashEntry = data;

    // Update summary cards
    $('#totalAmount').text('$' + parseFloat(data.grand_total || 0).toFixed(2));

    // Calculate bills and coins totals
    const billsTotal = (data.dollar_100_total || 0) + (data.dollar_50_total || 0) +
                      (data.dollar_10_total || 0) + (data.dollar_5_total || 0) +
                      (data.dollar_2_total || 0);

    const coinsTotal = (data.dollar_1_total || 0) + (data.cent_50_total || 0) + (data.cent_20_total || 0) +
                      (data.cent_10_total || 0) + (data.cent_5_total || 0);

    $('#billsTotal').text('$' + billsTotal.toFixed(2));
    $('#coinsTotal').text('$' + coinsTotal.toFixed(2));
    $('#entryInfo').text(data.entry_time || '--:--');

    // Populate bills table
    const billsData = [
        { name: '$100', qty: data.dollar_100_qty || 0, total: data.dollar_100_total || 0 },
        { name: '$50', qty: data.dollar_50_qty || 0, total: data.dollar_50_total || 0 },
        { name: '$10', qty: data.dollar_10_qty || 0, total: data.dollar_10_total || 0 },
        { name: '$5', qty: data.dollar_5_qty || 0, total: data.dollar_5_total || 0 },
        { name: '$2', qty: data.dollar_2_qty || 0, total: data.dollar_2_total || 0 }
    ];

    let billsHtml = '';
    billsData.forEach(function(item) {
        if (item.qty > 0) {
            billsHtml += `
                <tr>
                    <td><strong>${item.name}</strong></td>
                    <td>${item.qty}</td>
                    <td>$${parseFloat(item.total).toFixed(2)}</td>
                </tr>
            `;
        }
    });

    if (billsHtml === '') {
        billsHtml = '<tr><td colspan="3" class="text-center text-muted">No bills recorded</td></tr>';
    }
    $('#billsTable').html(billsHtml);

    // Populate coins table
    const coinsData = [
        { name: '$1', qty: data.dollar_1_qty || 0, total: data.dollar_1_total || 0 },
        { name: '50¢', qty: data.cent_50_qty || 0, total: data.cent_50_total || 0 },
        { name: '20¢', qty: data.cent_20_qty || 0, total: data.cent_20_total || 0 },
        { name: '10¢', qty: data.cent_10_qty || 0, total: data.cent_10_total || 0 },
        { name: '5¢', qty: data.cent_5_qty || 0, total: data.cent_5_total || 0 }
    ];

    let coinsHtml = '';
    coinsData.forEach(function(item) {
        if (item.qty > 0) {
            coinsHtml += `
                <tr>
                    <td><strong>${item.name}</strong></td>
                    <td>${item.qty}</td>
                    <td>$${parseFloat(item.total).toFixed(2)}</td>
                </tr>
            `;
        }
    });

    if (coinsHtml === '') {
        coinsHtml = '<tr><td colspan="3" class="text-center text-muted">No coins recorded</td></tr>';
    }
    $('#coinsTable').html(coinsHtml);

    // Update metadata
    $('#entryDate').text(data.entry_date || '--');
    $('#entryTimeDetail').text(data.entry_time || '--:--');
    $('#enteredBy').text(data.telegram_username || '--');

    const updatedAt = data.updated_at || data.created_at;
    if (updatedAt) {
        const date = new Date(updatedAt);
        $('#lastUpdated').text(date.toLocaleString());
    } else {
        $('#lastUpdated').text('--');
    }

    // Show sections
    $('#summaryCards').show();
    $('#denominationDetails').show();
}

function displayCashDataRange(dataArray, summary) {
    console.log('Displaying cash data range:', dataArray, summary);

    // Update summary cards with aggregated totals
    $('#totalAmount').text('$' + parseFloat(summary.total_amount || 0).toFixed(2));
    $('#billsTotal').text('$' + parseFloat(summary.bills_total || 0).toFixed(2));
    $('#coinsTotal').text('$' + parseFloat(summary.coins_total || 0).toFixed(2));

    // Update the fourth card to show number of entries
    $('#entryInfo').text(dataArray.length);
    $('#entryInfoLabel').text('Total Entries');
    $('#entryInfoIcon').removeClass('fa-clock').addClass('fa-list');

    // Update range summary banner
    const startDate = $('#startDate').val();
    const endDate = $('#endDate').val();
    const startFormatted = new Date(startDate).toLocaleDateString();
    const endFormatted = new Date(endDate).toLocaleDateString();

    $('#rangeDates').text(`${startFormatted} - ${endFormatted}`);
    $('#rangeEntries').text(`${dataArray.length} entries`);
    $('#rangeSummary').show();

    // Populate the data table
    let tableHtml = '';
    dataArray.forEach(function(entry) {
        const billsTotal = (entry.dollar_100_total || 0) + (entry.dollar_50_total || 0) +
                          (entry.dollar_10_total || 0) + (entry.dollar_5_total || 0) +
                          (entry.dollar_2_total || 0);

        const coinsTotal = (entry.dollar_1_total || 0) + (entry.cent_50_total || 0) + (entry.cent_20_total || 0) +
                          (entry.cent_10_total || 0) + (entry.cent_5_total || 0);

        const entryDate = new Date(entry.entry_date).toLocaleDateString();

        tableHtml += `
            <tr>
                <td>
                    <input type="checkbox" data-row-id="${entry.id}" onchange="toggleRowSelection(this, ${entry.id})">
                </td>
                <td>${entryDate}</td>
                <td>${entry.entry_time || '--:--'}</td>
                <td>$${parseFloat(entry.grand_total || 0).toFixed(2)}</td>
                <td>$${billsTotal.toFixed(2)}</td>
                <td>$${coinsTotal.toFixed(2)}</td>
                <td>${entry.telegram_username || '--'}</td>
                <td>
                    <button class="btn btn-sm btn-info me-1" onclick="viewEntryDetails('${entry.entry_date}')">
                        <i class="fas fa-eye"></i> View
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteCashEntry(${entry.id}, '${entry.entry_date}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </td>
            </tr>
        `;
    });

    $('#cashEntriesTable tbody').html(tableHtml);

    // Show sections
    $('#summaryCards').show();
    $('#rangeDataTable').show();
}

function viewEntryDetails(entryDate) {
    // Set the single date filter to the selected date
    $('#dateFilter').val(entryDate);

    // Switch back to single date mode
    $('#dateRangeToggle').prop('checked', false);
    $('#singleDateGroup').show();
    $('#dateRangeGroup').hide();
    $('#rangeDataTable').hide();
    $('#rangeSummary').hide();

    // Load the single entry data
    loadCashData();
}

// Delete single cash entry
function deleteCashEntry(entryId, entryDate) {
    const message = `Are you sure you want to delete the cash denomination entry for ${entryDate}? This action cannot be undone.`;

    showCustomConfirm(message, function() {
        $.ajax({
            url: `/api/cash-denomination/delete/${entryId}`,
            method: 'POST',
            success: function(response) {
                if (response.success) {
                    showFlashMessage('Cash denomination entry deleted successfully!', 'success');
                    // Refresh the appropriate view
                    if ($('#dateRangeToggle').is(':checked')) {
                        loadCashDataRange();
                    } else {
                        loadCashData();
                    }
                } else {
                    showFlashMessage('Error deleting entry: ' + response.error, 'error');
                }
            },
            error: function(xhr, status, error) {
                showFlashMessage('Error deleting entry: ' + error, 'error');
            }
        });
    });
}

// Bulk delete cash entries
function bulkDeleteCashEntries(selectedIds) {
    $.ajax({
        url: '/api/bulk-delete/cash-denomination',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ ids: selectedIds }),
        success: function(response) {
            if (response.success) {
                showFlashMessage(`Successfully deleted ${response.deleted_count} cash denomination entries!`, 'success');
                // Clear selections
                selectedRows = [];
                updateBulkDeleteButton();
                // Refresh the view
                if ($('#dateRangeToggle').is(':checked')) {
                    loadCashDataRange();
                } else {
                    loadCashData();
                }
            } else {
                showFlashMessage('Error deleting entries: ' + response.error, 'error');
            }
        },
        error: function(xhr, status, error) {
            showFlashMessage('Error deleting entries: ' + error, 'error');
        }
    });
}

// Show and hide entry form
function showEntryForm() {
    // Set form title to "Add"
    $('#formTitle').html('<i class="fas fa-plus"></i> Add Cash Denominations');

    // Set default date to selected date or today
    const selectedDate = $('#dateFilter').val() || new Date().toISOString().split('T')[0];
    $('#entryDateInput').val(selectedDate);

    // Reset form
    $('#cashDenominationForm')[0].reset();
    $('.denomination-input').val(0);
    calculateTotals();

    // Show form
    $('#entryForm').slideDown();
    $('#noDataMessage').hide();

    // Scroll to form
    $('html, body').animate({
        scrollTop: $('#entryForm').offset().top - 100
    }, 500);
}

function hideEntryForm() {
    $('#entryForm').slideUp();
}

// Edit cash entry - populate form with existing data
function editCashEntry() {
    if (!currentCashEntry) {
        showFlashMessage('No entry data available to edit', 'error');
        return;
    }

    // Set form title to "Edit"
    $('#formTitle').html('<i class="fas fa-edit"></i> Edit Cash Denominations');

    // Set the date
    $('#entryDateInput').val(currentCashEntry.entry_date);

    // Populate bills
    $('#dollar_100').val(currentCashEntry.dollar_100_qty || 0);
    $('#dollar_50').val(currentCashEntry.dollar_50_qty || 0);
    $('#dollar_10').val(currentCashEntry.dollar_10_qty || 0);
    $('#dollar_5').val(currentCashEntry.dollar_5_qty || 0);
    $('#dollar_2').val(currentCashEntry.dollar_2_qty || 0);

    // Populate coins
    $('#dollar_1').val(currentCashEntry.dollar_1_qty || 0);
    $('#cent_50').val(currentCashEntry.cent_50_qty || 0);
    $('#cent_20').val(currentCashEntry.cent_20_qty || 0);
    $('#cent_10').val(currentCashEntry.cent_10_qty || 0);
    $('#cent_5').val(currentCashEntry.cent_5_qty || 0);

    // Calculate and show totals
    calculateTotals();

    // Show form and scroll to it
    $('#entryForm').slideDown();
    $('html, body').animate({
        scrollTop: $('#entryForm').offset().top - 100
    }, 500);
}

// Delete single cash entry for current date
function deleteSingleCashEntry() {
    if (!currentCashEntry) {
        showFlashMessage('No entry data available to delete', 'error');
        return;
    }

    const entryDate = currentCashEntry.entry_date;
    const entryId = currentCashEntry.id;
    const grandTotal = currentCashEntry.grand_total || 0;

    // Create confirmation message with details
    const message = `Are you sure you want to delete the cash denomination entry for ${entryDate}?\n\nTotal Amount: $${parseFloat(grandTotal).toFixed(2)}\n\nThis action cannot be undone.`;

    // Show custom confirmation modal (defined in base.html)
    showCustomConfirm(message, function() {
        $.ajax({
            url: `/api/cash-denomination/delete/${entryId}`,
            method: 'POST',
            success: function(response) {
                if (response.success) {
                    showFlashMessage('Cash denomination entry deleted successfully!', 'success');
                    // Clear current entry
                    currentCashEntry = null;
                    // Reload data
                    loadCashData();
                } else {
                    showFlashMessage('Error deleting entry: ' + response.error, 'error');
                }
            },
            error: function(xhr, status, error) {
                showFlashMessage('Error deleting entry: ' + error, 'error');
            }
        });
    });
}

// Calculate totals dynamically
function calculateTotals() {
    // Bills
    const dollar_100 = parseInt($('#dollar_100').val() || 0);
    const dollar_50 = parseInt($('#dollar_50').val() || 0);
    const dollar_10 = parseInt($('#dollar_10').val() || 0);
    const dollar_5 = parseInt($('#dollar_5').val() || 0);
    const dollar_2 = parseInt($('#dollar_2').val() || 0);

    const billsTotal = (dollar_100 * 100) + (dollar_50 * 50) + (dollar_10 * 10) +
                      (dollar_5 * 5) + (dollar_2 * 2);

    // Coins
    const dollar_1 = parseInt($('#dollar_1').val() || 0);
    const cent_50 = parseInt($('#cent_50').val() || 0);
    const cent_20 = parseInt($('#cent_20').val() || 0);
    const cent_10 = parseInt($('#cent_10').val() || 0);
    const cent_5 = parseInt($('#cent_5').val() || 0);

    const coinsTotal = (dollar_1 * 1) + (cent_50 * 0.50) + (cent_20 * 0.20) +
                      (cent_10 * 0.10) + (cent_5 * 0.05);

    // Update displays
    $('#billsSubtotal').text(billsTotal.toFixed(2));
    $('#coinsSubtotal').text(coinsTotal.toFixed(2));
    $('#grandTotal').text((billsTotal + coinsTotal).toFixed(2));
}

// Show flash message function
function showFlashMessage(message, category) {
    // Remove any existing flash messages
    $('.dynamic-flash-message').remove();

    // Create the flash message HTML
    const alertClass = category === 'error' ? 'alert-danger' : `alert-${category}`;
    const iconClass = category === 'error' ? 'fas fa-exclamation-triangle' :
                     category === 'success' ? 'fas fa-check-circle' : 'fas fa-info-circle';

    const flashHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show dynamic-flash-message" role="alert">
            <i class="${iconClass}"></i> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;

    // Insert the flash message at the top of the card body
    $('.card-body').first().prepend(flashHtml);

    // Auto-dismiss after 5 seconds
    setTimeout(function() {
        $('.dynamic-flash-message').fadeOut(function() {
            $(this).remove();
        });
    }, 5000);
}
</script>
{% endblock %}